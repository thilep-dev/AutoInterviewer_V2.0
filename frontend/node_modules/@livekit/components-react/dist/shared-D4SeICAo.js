"use strict";const j=require("react"),r=require("./shared-ChNXN17z.js"),u=require("./shared-BPm3y_nD.js"),c=require("livekit-client");function J(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const i=J(j);function F(e){const t=r.useEnsureRoom(e),n=i.useCallback(async()=>{await t.startAudio()},[t]),s=i.useMemo(()=>r.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:o}=u.useObservableState(s,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:o,startAudio:n}}function q(e){const{state:t,dispatch:n}=u.useLayoutContext().pin;return{buttonProps:i.useMemo(()=>{const{className:o}=r.setupClearPinButton();return u.mergeProps(e,{className:o,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function U(e,t){const n=typeof e=="function"?e:t,s=typeof e=="string"?e:void 0,o=r.useRoomContext(),{send:a,messageObservable:d,isSendingObservable:l}=i.useMemo(()=>r.setupDataMessageHandler(o,s,n),[o,s,n]),p=u.useObservableState(d,void 0),m=u.useObservableState(l,!1);return{message:p,send:a,isSending:m}}const $={connect:!0,audio:!1,video:!1};function z(e){const{token:t,serverUrl:n,options:s,room:o,connectOptions:a,connect:d,audio:l,video:p,screen:m,onConnected:g,onDisconnected:b,onError:v,onMediaDeviceFailure:k,onEncryptionError:T,simulateParticipants:y,...C}={...$,...e};s&&o&&r.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[f,B]=i.useState(),R=i.useRef(d);i.useEffect(()=>{B(o??new c.Room(s))},[o,JSON.stringify(s,u.roomOptionsStringifyReplacer)]);const L=i.useMemo(()=>{const{className:P}=r.setupLiveKitRoom();return u.mergeProps(C,{className:P})},[C]);return i.useEffect(()=>{if(!f)return;const P=()=>{const S=f.localParticipant;r.log.debug("trying to publish local tracks"),Promise.all([S.setMicrophoneEnabled(!!l,typeof l!="boolean"?l:void 0),S.setCameraEnabled(!!p,typeof p!="boolean"?p:void 0),S.setScreenShareEnabled(!!m,typeof m!="boolean"?m:void 0)]).catch(O=>{r.log.warn(O),v==null||v(O)})},M=S=>{const O=c.MediaDeviceFailure.getFailure(S);k==null||k(O)},A=S=>{T==null||T(S)},x=S=>{b==null||b(S)},w=()=>{g==null||g()};return f.on(c.RoomEvent.SignalConnected,P).on(c.RoomEvent.MediaDevicesError,M).on(c.RoomEvent.EncryptionError,A).on(c.RoomEvent.Disconnected,x).on(c.RoomEvent.Connected,w),()=>{f.off(c.RoomEvent.SignalConnected,P).off(c.RoomEvent.MediaDevicesError,M).off(c.RoomEvent.EncryptionError,A).off(c.RoomEvent.Disconnected,x).off(c.RoomEvent.Connected,w)}},[f,l,p,m,v,T,k,g,b]),i.useEffect(()=>{if(f){if(y){f.simulateParticipants({participants:{count:y},publish:{audio:!0,useRealTracks:!0}});return}if(d){if(R.current=!0,r.log.debug("connecting"),!t){r.log.debug("no token yet");return}if(!n){r.log.warn("no livekit url provided"),v==null||v(Error("no livekit url provided"));return}f.connect(n,t,a).catch(P=>{r.log.warn(P),R.current===!0&&(v==null||v(P))})}else r.log.debug("disconnecting because connect is false"),R.current=!1,f.disconnect()}},[d,t,JSON.stringify(a),f,v,n,y]),i.useEffect(()=>{if(f)return()=>{r.log.info("disconnecting on onmount"),f.disconnect()}},[f]),{room:f,htmlProps:L}}function K(e={}){let t=u.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=i.useMemo(()=>r.participantInfoObserver(t),[t]),{identity:s,name:o,metadata:a}=u.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:s,name:o,metadata:a}}function V(e={}){const t=u.useEnsureParticipant(e.participant),n=i.useMemo(()=>r.participantPermissionObserver(t),[t]);return u.useObservableState(n,t.permissions)}function h(e={}){const t=r.useEnsureRoom(e.room),[n,s]=i.useState([]);return i.useEffect(()=>{const o=r.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(s);return()=>o.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function G(e={}){const t=h(e),{localParticipant:n}=r.useLocalParticipant(e);return i.useMemo(()=>[n,...t],[n,t])}function W(e,t={}){const n=r.useRoomContext(),[s]=i.useState(t.updateOnlyOn),o=i.useMemo(()=>typeof e=="string"?r.connectedParticipantObserver(n,e,{additionalEvents:s}):r.participantByIdentifierObserver(n,e,{additionalEvents:s}),[n,JSON.stringify(e),s]),[a,d]=i.useState({p:void 0});return i.useEffect(()=>{const l=o.subscribe(p=>d({p}));return()=>l.unsubscribe()},[o]),a.p}function H(e={}){const t=r.useEnsureRoom(e.room),n=i.useMemo(()=>r.roomInfoObserver(t),[t]),{name:s,metadata:o}=u.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:s,metadata:o}}function N(){const e=r.useRoomContext(),t=i.useMemo(()=>r.activeSpeakerObserver(e),[e]);return u.useObservableState(t,e.activeSpeakers)}function Q(e){const[t,n]=i.useState(r.sortParticipants(e)),s=N();return i.useEffect(()=>{n(r.sortParticipants(e))},[s,e]),t}function X(e,t,n={}){const[s,o]=i.useState(void 0);return i.useEffect(()=>{var d;if(e===void 0)throw Error("token endpoint needs to be defined");if(((d=n.userInfo)==null?void 0:d.identity)===void 0)return;(async()=>{r.log.debug("fetching token");const l=new URLSearchParams({...n.userInfo,roomName:t}),p=await fetch(`${e}?${l.toString()}`);if(!p.ok){r.log.error(`Could not fetch token. Server responded with status ${p.status}: ${p.statusText}`);return}const{accessToken:m}=await p.json();o(m)})()},[e,t,JSON.stringify(n)]),s}function Y(e){const[t,n]=i.useState(r.getTrackByIdentifier(e)),{trackObserver:s}=i.useMemo(()=>r.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return i.useEffect(()=>{const o=s.subscribe(a=>{n(a)});return()=>o==null?void 0:o.unsubscribe()},[s]),{participant:e.participant,source:e.source??c.Track.Source.Unknown,publication:t}}function Z(e,t){const n=u.useEnsureParticipant(t);return Y({name:e,participant:n})}function E(e,t){const n=r.useRoomContext(),s=u.useMaybeParticipantContext(),o=t?n.getParticipantByIdentity(t):s,a=i.useMemo(()=>o?r.participantTracksObservable(o,{sources:e}):void 0,[o==null?void 0:o.sid,o==null?void 0:o.identity,JSON.stringify(e)]);return u.useObservableState(a,[])}function ee(e){var n,s,o;const t=i.useMemo(()=>{var a;return(a=e==null?void 0:e.publication)!=null&&a.track?r.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return u.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(o=(s=e==null?void 0:e.publication)==null?void 0:s.track)==null?void 0:o.rtpTimestamp})}const te={bufferSize:100};function I(e,t){const n={...te,...t},[s,o]=i.useState([]),a=ee(e),d=l=>{var p;(p=n.onTranscription)==null||p.call(n,l),o(m=>r.dedupeSegments(m,l.map(g=>r.addMediaTimestampToTranscription(g,a)),n.bufferSize))};return i.useEffect(()=>{if(!(e!=null&&e.publication))return;const l=r.trackTranscriptionObserver(e.publication).subscribe(p=>{d(...p)});return()=>{l.unsubscribe()}},[e&&r.getTrackReferenceId(e),d]),{segments:s}}function _(e={}){const t=u.useMaybeParticipantContext(),n=e.participant??t,s=i.useMemo(()=>r.participantAttributesObserver(n),[n]);return u.useObservableState(s,{attributes:n==null?void 0:n.attributes})}function ne(e,t={}){const n=u.useEnsureParticipant(t.participant),[s,o]=i.useState(n.attributes[e]);return i.useEffect(()=>{if(!n)return;const a=r.participantAttributesObserver(n).subscribe(d=>{d.changed[e]!==void 0&&o(d.attributes[e])});return()=>{a.unsubscribe()}},[n,e]),s}const D="lk.agent.state";function se(){const e=h(),t=e.find(b=>b.kind===c.ParticipantKind.AGENT&&!("lk.publish_on_behalf"in b.attributes)),n=e.find(b=>b.kind===c.ParticipantKind.AGENT&&b.attributes["lk.publish_on_behalf"]===(t==null?void 0:t.identity)),s=E([c.Track.Source.Microphone,c.Track.Source.Camera],t==null?void 0:t.identity),o=E([c.Track.Source.Microphone,c.Track.Source.Camera],n==null?void 0:n.identity),a=s.find(b=>b.source===c.Track.Source.Microphone)??o.find(b=>b.source===c.Track.Source.Microphone),d=s.find(b=>b.source===c.Track.Source.Camera)??o.find(b=>b.source===c.Track.Source.Camera),{segments:l}=I(a),p=u.useConnectionState(),{attributes:m}=_({participant:t}),g=i.useMemo(()=>p===c.ConnectionState.Disconnected?"disconnected":p===c.ConnectionState.Connecting||!t||!(m!=null&&m[D])?"connecting":m[D],[m,t,p]);return{agent:t,state:g,audioTrack:a,videoTrack:d,agentTranscriptions:l,agentAttributes:m}}function oe(e){const t=r.useEnsureRoom(e),n=u.useConnectionState(t),s=i.useMemo(()=>r.recordingStatusObservable(t),[t,n]);return u.useObservableState(s,t.isRecording)}function re(e){const t=r.useRoomContext(),s=u.useConnectionState(t)===c.ConnectionState.Disconnected,o=i.useMemo(()=>r.setupTextStream(t,e),[t,e]),a=s?void 0:o;return{textStreams:u.useObservableState(a,[])}}exports.useAudioPlayback=F;exports.useClearPinButton=q;exports.useDataChannel=U;exports.useIsRecording=oe;exports.useLiveKitRoom=z;exports.useParticipantAttribute=ne;exports.useParticipantAttributes=_;exports.useParticipantInfo=K;exports.useParticipantPermissions=V;exports.useParticipantTracks=E;exports.useParticipants=G;exports.useRemoteParticipant=W;exports.useRemoteParticipants=h;exports.useRoomInfo=H;exports.useSortedParticipants=Q;exports.useSpeakingParticipants=N;exports.useTextStream=re;exports.useToken=X;exports.useTrackByName=Z;exports.useTrackTranscription=I;exports.useVoiceAssistant=se;
//# sourceMappingURL=shared-D4SeICAo.js.map
